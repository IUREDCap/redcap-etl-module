REDCap-ETL Developer Guide
======================================

This guide is intended for people who want to modify or extend the REDCap-ETL software.
If you just want to use the REDCap-ETL software, please see the installation and configuration guides.

Development Environment Setup
-------------------------------------

This is a list of the steps for setting up a REDCap-ETL development environment. Example commands are shown for Ubuntu 16.

1. Install PHP

        sudo apt install php php-curl php-mbstring php-mysql php-xml
        sudo phpenmod mysqli   # enable mysqli extension
        sudo phpenmod pdo_mysql # enable PDO extension for PHP
        sudo apt install php-sqlite3  # add PHP support for SQLite
        sudo apt install php-xdebug  # Install XDebug to be able to see phpunit test code coverage

2. Install Composer (needed to get PHPCap and development dependencies)

        sudo apt install composer

3. Install sendmail (needed for logging to e-mail)

        sudo apt install sendmail
        
    Note: after REDCap-ETL has been installed, its **bin/email_test.php** script can be used to test if e-mail logging
works.

4. Install MySQL

        sudo apt install mysql-server
        sudo mysql_secure_installation
        systemctl status mysql.service   # check status
        
        # Set up SSL
        sudo mysql_ssl_rsa_setup --uid=mysql
        sudo systemctl restart mysql


5. Create a database and database user that will be used as the place to store the REDCap data, for example, in MySQL use:

        CREATE DATABASE `etl_test`;
        CREATE USER 'etl_user'@'localhost' IDENTIFIED BY 'etlPassword';
        GRANT ALL ON `etl_test`.* TO 'etl_user'@'localhost';

6. Install SQLite

        sudo apt install sqlite3
        sudo apt install sqlitebrowser  # optional

7. Install Git

        sudo apt install git
        # Add e-mail and name information, for example:
        git config --global user.email "jsmith@someuniversity.edu"
        git config --global user.name "J Smith"

9. Get the code. Execute the following command in the directory where
   you want to put REDCap-ETL:

        git clone https://github.com/IUREDCap/redcap-etl

10. Install Composer dependencies. In the top-level directory where the code was downloaded, run:

        composer install

### REDCap-ETL Directory Structure

After the steps above have been successfully completed,
the REDCap-ETL software directory should have a structure similar to
what is listed below. The main directories and files are as follows:

* __bin/__ - directory containing scripts
* __config/__ - default configuration directory for REDCap-ETL
* __dependencies/__ - static dependencies used for production installation
* __docs/__ - documentation
* __projects/__ - REDCap-ETL project templates for configuration and logging
* __src/__ - the REDCap-ETL source code directory
* __tests/__ - automated tests directory
    * __config/__ - directory for test configuration files that have been
    customized for your system
    * __config-init/__ - initial test configuration files for copying and
    then customizing for your specific installation
    * __coverage/__ - directory set up for storing testing code coverage
    reports, where files are ignored by Git
    * __data/__ - test result comparison data
    * __integration/__ - code for integration tests
    * __logs/__ - test log files (ignored by Git)
    * __output/__ - test generate output files (ignored by Git)
    * __projects/__ - test REDCap projects
    * __system/__ - code for system tests
    * __unit/__ - code for unit tests 
* __vendor/__ - directory where the dependencies generated by Composer
are installed
* _composer.json_ - JSON configuration file for Composer
* _phpunit.xml_ - configuration file for automated tests run with PHPUnit 
* _README.md_ - main README file for REDCap-ETL



Automated Tests
------------------------------

There are 3 types of automated tests:

1. __Unit__ - each test focuses on a single class
2. __Integration__ - tests focus on the integration of multiple classes
3. __System__ - tests focus on testing the system as a whole (multiple classes + scripts)

The test types above are listed in order of least to most setup effort.

|                                                               | Unit |Integration | System    |
|---------------------------------------------------------------|------|:----------:|:---------:|
| __Configuration file setup required__                         |      | &#10003;   | &#10003;  |
| __REDCap and REDCap project setup required__                  |      | &#10003;   | &#10003;  |
| __MySQL and SQLite database setup required for loading data__ |      |            | &#10003;  |



### Unit Tests
You should be able to run the unit tests at this point if you have
completed the previous steps.
To run the unit tests, enter the following in a command shell
at the top-level directory of the REDCap-ETL installation:

    ./vendor/bin/phpunit --testsuite unit
    
If this command runs successfully, you should see an "OK" message that
indicates the number of tests and assertions that were successful.

### Integration and System Tests
Setting up the integration and system tests requires having access
to a REDCap instance, and the ability to get API tokens for projects
on that instance. Setting these tests up is not required, but
the tests have much better code coverage when they are.

#### Integration tests
To set up the integration tests, you need to first set up
the "Basic Demography" and "Repeating Events" REDCap projects that have
the data for the tests:

1. In REDCap, create one project using the
   "Upload a REDCap project XML file" option, for each of the
   following files from REDCap-ETL:

        tests/projects/BasicDemography.REDCap.xml
        tests/projects/RepeatingEvents.REDCap.xml
        tests/projects/Visits.REDCap.xml

2. Request API tokens for the projects you just created (or
   create tokens if you are an admin). The tokens needs to have export
   permission.

The next thing you need to do is to create the configuration files
for the tests:

1. Copy the configuration and transformation rules
   files from the tests/config-init directory to the tests/config
   directory. From the top-level directory:

        cp tests/config-init/basic-demography.ini tests/config
        cp tests/config-init/basic-demography-rules.txt tests/config
        cp tests/config-init/basic-demography.json tests/config
        cp tests/config-init/basic-demography-2.ini tests/config
        cp tests/config-init/basic-demography-bad-field-name.ini tests/config 
        cp tests/config-init/basic-demography-rules-badFieldName.txt tests/config
        cp tests/config-init/basic-demography-bad-rule.ini tests/config
        cp tests/config-init/basic-demography-rules-badRule.txt tests/config
        cp tests/config-init/repeating-events.ini tests/config
        cp tests/config-init/repeating-events-rules.txt tests/config
        cp tests/config-init/visits-empty-rules.ini tests/config
        cp tests/config-init/visits-empty-rules.txt tests/config
        cp tests/config-init/visits-missing-suffix.ini tests/config
        cp tests/config-init/visits-missing-suffix-rules.txt tests/config

2. Edit the .ini and .json configuration files that were copied to the tests/config/
   directory, and set the following properties to appropriate values:
   
    1. **redcap_api_url** - set this to the URL for your REDCap's API. Be
       sure to set this to the URL for the _API_, which typically ends
       with "/api/".

    2. **data_source_api_token** - for the basic demography configuration (.ini)
       files, set this to the REDCap API token for your REDCap Basic Demography
       project created above. And for the repeating events configuration (.ini)
       file, set it to the REDCap API token for the Repeating Events project
       created above.
       
    3. **ssl_verify** - if you are using a REDCap instance for testing that has no,
       or a self-signed, SSL certificate, you will also need to set the ssl_verify
       property to 'false' (note: include the single quotes).


3. Also copy the following file, but do not edit it. It is used for error testing.

        cp tests/config-init/basic-demography-3.ini tests/config

After the above steps have been completed successfully, you should be
able to run the integration tests by executing the following command
in the top-level directory of your REDCap-ETL installation:

    ./vendor/bin/phpunit --testsuite integration


#### System tests

Steps for setting up the REDCap projects:

__REDCap Project Setup.__ If you did not already set up the "Repeating Events" and "Visits" projects as described
in the steps for setting up integration tests, then you need to do that now.


__SQLite Database Setup.__ You need to create SQLite test databases. Use the following commands

    cd tests/output
    sqlite3 repeating-events.db
    sqlite3 visits.db

When in the sqlite shell from executing the above sqlite3 commands, enter the following:

    .databases
    .quit

__SQL Server Database Setup.__ If you want to run the SQL Server automated tests, you need to have a SQL Server database. For information on setting
one up on Ubuntu 18, see [SQL Server](SqlServer.md).

__ETL Configuration File Setup.__ The next thing you need to do is to create the configuration files for the "Repeating Events" and "Visits" projects:


1. Copy the visits configuration and SQL post-processing files from the 
   tests/config-init directory to the tests/config
   directory, for example, from the top-level directory:

        cp tests/config-init/repeating-events-mysql-rules.txt tests/config
        cp tests/config-init/repeating-events-mysql.ini tests/config
        cp tests/config-init/repeating-events-sqlite.ini tests/config
        cp tests/config-init/visits.ini tests/config
        cp tests/config-init/visits-sqlite.ini tests/config
        cp tests/config-init/visits-rules.txt tests/config
        cp tests/config-init/visits.sql tests/config

2. If you have a MySQL database that supports SSL and has a certified SSL certificate, then also
   copy the following configuration file:

        cp tests/config-init/mysql-ssl.ini tests/config

3. If you have a SQL Server database, then also
   copy the following configuration files:

        cp tests/config-init/sqlserver.ini tests/config
        cp tests/config-init/sqlserver-ssl.ini tests/config
        cp tests/config-init/repeating-events-sqlserver.ini tests/config

4. Edit the __tests/config/visits.ini__ and __tests/config/visits-sqlite.ini__ files and set the 
   following properties to appropriate values:
   
    1. **redcap_api_url** - set this to the URL for your REDCap's API. Be
       sure to set this to the URL for the _API_, which typically ends
       with "/api/".

    2. **data_source_api_token** - set this to the REDCap API token for
       your REDCap Visits project created above.

    3. **ssl_verify** - if you are using a REDCap instance for testing that has no,
       or a self-signed, SSL certificate, you will also need to set the ssl_verify
       property to 'false' (note: include the single quotes).

5. Edit the __tests/config/repeating-events-mysql.ini__ and __tests/config/repeating-events-sqlite.ini__ files,
   and set the following properties to appropriate values:
   
    1. **redcap_api_url** - set this to the URL for your REDCap's API. Be
       sure to set this to the URL for the _API_, which typically ends
       with "/api/".

    2. **data_source_api_token** - set this to the REDCap API token for
       your REDCap Repeating Events project created above.

    3. **ssl_verify** - if you are using a REDCap instance for testing that has no,
       or a self-signed, SSL certificate, you will also need to set the ssl_verify
       property to 'false' (note: include the single quotes).

6. If you are setting up the __mysql-ssl.ini__ file,
   edit it and modify the values listed in the previous step.
   In addition, set the **db_connection** property with the information
   for your database that supports SSL and has a certified SSL certificate. In addition, you need
   to create a **ca.crt** file in the __tests/config__ directory that is a valid certificate
   authority certificate file. If this file is missing, the MySQL SSL tests will be skipped.

7. If you are setting up the SQL Server tests, edit and set the **sqlserver** configuration files
   the sames as the **repeating-events** files set above, and then also set the **db_connection**
   property to match the SQL Server database, login and user that you set up.


8. If you used different values than those used in the example
    commands above for creating the MySQL database and user, you will need to
    modify the __db_connection__ property appropriately in file
    __tests/config/repeating-events-mysql.ini__.

You can check the setup so far for the visits tests by running
the following command in the
top-level directory of you REDCap-ETL installation:

        ./bin/project_info.php tests/config/visits.ini 
    
If things have been set up correctly, you should see the correct
project names displayed for the configuration, data and logging
projects.

You can also check the configuration for errors with the following
command:

        ./bin/config_check.php tests/config/visits.ini 


After the above steps have been completed successfully, you should be
able to run the system tests by executing the following command
in the top-level directory of your REDCap-ETL installation:

    ./vendor/bin/phpunit --testsuite system


### Running the Tests

To run all of the automated test, in the top-level directory run:

    ./vendor/bin/phpunit

The system tests use the REDCap-ETL scripts, so the DET web script
will need to be set up.


#### Generating test coverage

To see test coverage information, you need to have XDebug installed, and
then run the following command from the root directory of the project:

    ./vendor/bin/phpunit --coverage-html tests/coverage

Then with a browser, open the file:

    tests/coverage/index.html

The output
could be stored in a different directory, but directory tests/coverage
has been set up to be ignored by Git.

API Documentation
-----------------------------------

The API documentation is programmatically generated and is not stored
in GitHub.

To generate the API documentation, execute the following command in the
top-level REDCap-ETL directory:

    ./vendor/bin/apigen generate
    
To view the API documentation, open the following file with a web browser:

    ./docs/api/index.html

Note that the version of apigen used does not appear to work 
with PHP 7.2.

---

Modifying the Code
------------------------------


### Coding Standards Compliance

REDCap-ETL follows these PHP coding standards:

* [PSR-1: Basic Coding Standard](http://www.php-fig.org/psr/psr-1/)
* [PSR-2: Coding Style Guide](http://www.php-fig.org/psr/psr-2/)
* [PSR-4: Autoloader](http://www.php-fig.org/psr/psr-4/)
* Lower camel case variable names, e.g., $primaryKey

From the top-level directory of your REDCap-ETL installation,
the following command can be used
to check for coding standards compliance:

    ./vendor/bin/phpcs

The coding standards checks that are done (by default) are configured in the file __phpcs.xml__ in the top-level directory.



### REDCap-ETL Software Architecture

For more information, see: [REDCap-ETL Software Architecture](SoftwareArchitecture.md)


### Adding a New Database Type

If you want to add a new database type (e.g., Oracle, PostgreSQL) to REDCap-ETL you need to
do the following:

* Create a new database connection class for the new database type that:
    * extends class PdoDbConnection, if the connection uses
        [PDO](https://www.php.net/manual/en/book.pdo.php) (PHP Data Objects)
    * extends class DbConnection, if the connection does not use PDO
* Modify class DbConnectionFactory to add your new database type:
    * Add a new constant for your database type
    * Add a case for your new database type in the constructor


![REDCap-ETL Database Connection Classes](redcap-etl-db-connections.png)


